<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Grundlagen der Betriebswirtschaftslehre – Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --border: #334155;
      --accent: #38bdf8;
      --good: #22c55e;
      --bad: #ef4444;
      --text: #e2e8f0;
    }
body {
  background: var(--bg);
  color: var(--text);
  font-family: system-ui, -apple-system, sans-serif;
  margin: 0;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 16px;
}

.hidden {
  display: none;
}

    .app {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px 20px;
      width: min(900px, 100%);
      box-shadow: 0 20px 40px rgba(0,0,0,.25);
      position: relative;
    }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .title {
      font-weight: 700;
      font-size: 1rem;
    }
    .timer {
      background: rgba(248, 113, 113, 0.08);
      border: 1px solid rgba(248, 113, 113, 0.3);
      border-radius: 9999px;
      padding: 4px 12px;
      font-weight: 600;
      min-width: 70px;
      text-align: center;
    }
    .info-line {
      font-size: .8rem;
      opacity: .75;
      margin-bottom: 12px;
    }
    .question-box {
      background: rgba(15,23,42,.3);
      border: 1px solid rgba(148,163,184,.1);
      border-radius: 12px;
      padding: 14px 14px 10px 14px;
      margin-bottom: 14px;
    }
    .tag {
      text-transform: uppercase;
      letter-spacing: .12em;
      font-size: .65rem;
      opacity: .6;
      margin-bottom: .35rem;
    }
    .frage {
      font-size: 1.05rem;
      font-weight: 600;
      margin-bottom: .75rem;
    }
    .input-box, .mc-box {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 10px;
      margin-bottom: .75rem;
    }
    .input-box input {
      width: 100%;
      background: rgba(15,23,42,0);
      border: 1px solid rgba(148,163,184,.35);
      border-radius: 8px;
      padding: 7px 9px;
      color: #e2e8f0;
      outline: none;
    }
    .mc-option {
      display: block;
      width: 100%;
      text-align: left;
      background: rgba(15,23,42,.5);
      border: 1px solid rgba(148,163,184,.2);
      border-radius: 10px;
      padding: 8px 10px;
      margin-bottom: 6px;
      cursor: pointer;
      color: #e2e8f0;   /* sichtbar machen */
      font-weight: 500;
    }
    .buttons {
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
      margin-top: .5rem;
    }
    button {
      background: var(--accent);
      border: none;
      border-radius: 9999px;
      padding: 8px 14px;
      font-weight: 600;
      cursor: pointer;
      color: #0f172a;
    }
    button.secondary {
      background: transparent;
      border: 1px solid var(--accent);
      color: #e2e8f0;
    }
    button.danger {
      background: var(--bad);
      color: #0f172a;
    }
    button:disabled {
      opacity: .45;
      cursor: not-allowed;
    }
    .scoreline {
      font-size: .8rem;
      margin-top: .6rem;
      opacity: .75;
    }
    .finished {
      font-size: 1.1rem;
      font-weight: 600;
      margin-top: 1rem;
    }
    .esel {
      margin-top: .5rem;
      font-size: .75rem;
      opacity: .7;
    }
    /* Popup */
    #explainOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.75);
      backdrop-filter: blur(2px);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #explainBox {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 14px;
      max-width: 620px;
      width: 92%;
      padding: 16px 18px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="title">Grundlagen der Betriebswirtschaftslehre – Test</div>
      <div id="timer" class="timer">90:00</div>
    </div>
    <div class="info-line" id="infoLine">Frage 1 von 20 · 90 Minuten Prüfungszeit.</div>
    <div id="questionBox" class="question-box">
      <div id="tag" class="tag"></div>
      <div id="frage" class="frage"></div>

      <div id="inputBox" class="input-box hidden">
        <input id="userInput" type="text" placeholder="Antwort eingeben …" />
        <button id="checkInputBtn" style="margin-top:6px;">Prüfen</button>
        <div id="inputFeedback" class="feedback"></div>
      </div>

      <div id="mcBox" class="mc-box hidden"></div>

      <div id="esel" class="esel"></div>
    </div>
    <div class="buttons">
      <button id="nextBtn" class="secondary">Nächste Frage</button>
      <button id="showSolutionBtn" class="secondary">Lösung anzeigen</button>
      <button id="showExplainBtn" class="secondary" disabled>Erklärung</button>
      <button id="restartBtn" class="danger">Test neu starten</button>
      <button id="exportBtn" class="secondary">Ergebnisse exportieren</button>
    </div>
    <div id="scoreline" class="scoreline">Punkte: 0 / 0 (0%)</div>
    <div id="finalBox" class="finished hidden"></div>
  </div>

  <!-- Erklärung-Popup -->
  <div id="explainOverlay">
    <div id="explainBox">
      <div id="explainTitle" style="font-weight:600; margin-bottom:6px;">Erklärung</div>
      <div id="explainText" style="font-size:.85rem; line-height:1.4;"></div>
      <button id="closeExplainBtn" style="margin-top:12px; background:#38bdf8; border:none; border-radius:9999px; padding:6px 12px; font-weight:600; cursor:pointer; color:#0f172a;">Schließen</button>
    </div>
  </div>

  <script>
    const MAX_TIME_SECONDS = 90 * 60; // 90 Minuten
    const QUESTIONS_PER_TEST = 20;
    const RESULTS_FILENAME = "bwl_test_ergebnisse.csv";

    let allQuestions = [];
    let currentQuestions = [];
    let currentIndex = 0;
    let score = 0;
    let answered = 0;
    let timerInterval = null;
    let secondsLeft = MAX_TIME_SECONDS;
    let results = []; // {id, frage, user, korrekt, zeit}

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    async function loadQuestions() {
      const res = await fetch("bwl_test.json");
      allQuestions = await res.json();
      startNewTest();
    }

    function startNewTest() {
      score = 0;
      answered = 0;
      results = [];
      document.getElementById("finalBox").classList.add("hidden");

      const copy = [...allQuestions];
      shuffle(copy);
      currentQuestions = copy.slice(0, QUESTIONS_PER_TEST);
      currentIndex = 0;

      if (timerInterval) clearInterval(timerInterval);
      secondsLeft = MAX_TIME_SECONDS;
      updateTimer();
      timerInterval = setInterval(tick, 1000);

      renderQuestion();
      updateScoreline();
    }

    function tick() {
      secondsLeft--;
      updateTimer();
      if (secondsLeft <= 0) {
        clearInterval(timerInterval);
        finishTest(true);
      }
    }

    function updateTimer() {
      const m = Math.floor(secondsLeft / 60);
      const s = secondsLeft % 60;
      document.getElementById("timer").textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    }

function renderQuestion() {
  const q = currentQuestions[currentIndex];
  if (!q) return;

  // Grundinfo setzen
  document.getElementById("tag").textContent = q.tag || "";
  document.getElementById("frage").textContent = q.frage;
  document.getElementById("esel").textContent = q.esel || "";
  document.getElementById("infoLine").textContent =
    `Frage ${currentIndex + 1} von ${currentQuestions.length} · 90 Minuten Prüfungszeit.`;

  // VOR dem Rendern immer beides ausblenden und leeren
  const inputBox = document.getElementById("inputBox");
  const mcBox = document.getElementById("mcBox");
  const inputFeedback = document.getElementById("inputFeedback");
  const userInput = document.getElementById("userInput");

  inputBox.classList.add("hidden");
  mcBox.classList.add("hidden");
  mcBox.innerHTML = "";
  inputFeedback.textContent = "";
  if (userInput) userInput.value = "";

  // Erklärung wieder sperren
  document.getElementById("showExplainBtn").disabled = true;

  // jetzt abhängig vom Typ rendern
  if (q.typ === "mc") {
    renderMC(q);
  } else {
    renderInput(q);
  }
}

    function renderMC(q) {
  // sicherstellen, dass das Eingabefeld weg ist
  const inputBox = document.getElementById("inputBox");
  const inputFeedback = document.getElementById("inputFeedback");
  const userInput = document.getElementById("userInput");
  inputBox.classList.add("hidden");
  inputFeedback.textContent = "";
  if (userInput) userInput.value = "";

  // MC-Box vorbereiten
  const box = document.getElementById("mcBox");
  box.innerHTML = "";                 // alte Antworten weg
  box.classList.remove("hidden");

  const options = shuffle([...q.optionen]);
  options.forEach(opt => {
    const btn = document.createElement("button");
    btn.textContent = opt;
    btn.className = "mc-option";
    btn.onclick = () => {
      const richtig = normalize(opt) === normalize(q.loesung);
      handleAnswer(q, opt, richtig);
      btn.style.background = richtig ? "rgba(34,197,94,.4)" : "rgba(239,68,68,.4)";
      btn.style.color = "#0f172a";
    };
    box.appendChild(btn);
  });
}

function renderInput(q) {
  const inputBox = document.getElementById("inputBox");
  const feedback = document.getElementById("inputFeedback");
  const userInput = document.getElementById("userInput");

  // MC-Bereich sicher räumen
  const mcBox = document.getElementById("mcBox");
  mcBox.innerHTML = "";               // alte MC-Antworten weg
  mcBox.classList.add("hidden");      // und ausblenden

  // Input anzeigen
  inputBox.classList.remove("hidden");
  feedback.textContent = "";
  feedback.style.color = "#e2e8f0";
  userInput.value = "";

  document.getElementById("checkInputBtn").onclick = () => {
    const val = userInput.value.trim();
    const richtig = checkInputAnswer(q, val);
    handleAnswer(q, val, richtig);

    if (richtig) {
      feedback.textContent = "Richtig ✅";
      feedback.style.color = "#22c55e";
    } else {
      feedback.style.textAlign = "left";
      feedback.style.color = "#ef4444";

      if (q.typ === "calc" && typeof q.loesungNumerisch !== "undefined") {
        feedback.innerHTML = "Nicht ganz ❌<br>Richtige Lösung: <strong>" + q.loesungNumerisch + "</strong>";
      } else if (Array.isArray(q.korrekteAntworten) && q.korrekteAntworten.length > 0) {
        feedback.innerHTML = "Nicht ganz ❌<br>Mögliche richtige Lösungen:<br>- " + q.korrekteAntworten.join("<br>- ");
      } else if (Array.isArray(q.schluesselwoerter) && q.schluesselwoerter.length > 0) {
        feedback.innerHTML = "Nicht ganz ❌<br>Das musste vorkommen:<br>- " + q.schluesselwoerter.join("<br>- ");
      } else {
        feedback.textContent = "Nicht ganz ❌";
      }
    }
  };
}

    function normalize(str) {
      return (str || "")
        .toString()
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[.,;:!?]/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

function checkInputAnswer(q, userVal) {
  if (q.typ === "calc") {
    const num = parseFloat((userVal || "").replace(",", "."));
    if (isNaN(num)) return false;
    const tol = q.toleranz || 0;
    return Math.abs(num - q.loesungNumerisch) <= tol;
  }

  const userNorm = normalize(userVal);

  if (q.schluesselwoerter && q.schluesselwoerter.length > 0) {
    let ok = 0;
    for (const kw of q.schluesselwoerter) {
      const kwNorm = normalize(kw);
      if (userNorm.includes(kwNorm)) {
        ok++;
      } else {
        const parts = userNorm.split(" ");
        const near = parts.some(p => editDistance(p, kwNorm) <= 1);
        if (near) ok++;
      }
    }
    return ok === q.schluesselwoerter.length;
  }

  if (q.korrekteAntworten && q.korrekteAntworten.length > 0) {
    return q.korrekteAntworten.some(ans => normalize(ans) === userNorm);
  }

  return false;
}

    function editDistance(a, b) {
      const dp = Array.from({length: a.length + 1}, () => Array(b.length + 1).fill(0));
      for (let i = 0; i <= a.length; i++) dp[i][0] = i;
      for (let j = 0; j <= b.length; j++) dp[0][j] = j;
      for (let i = 1; i <= a.length; i++) {
        for (let j = 1; j <= b.length; j++) {
          if (a[i-1] === b[j-1]) dp[i][j] = dp[i-1][j-1];
          else dp[i][j] = Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]) + 1;
        }
      }
      return dp[a.length][b.length];
    }

    function handleAnswer(q, userVal, richtig) {
      answered++;
      if (richtig) score++;

      results.push({
        id: q.id,
        frage: q.frage,
        user: userVal,
        korrekt: richtig ? "ja" : "nein",
        zeit: new Date().toISOString()
      });

      updateScoreline();

      // Erklärung nach Antwort freigeben
      document.getElementById("showExplainBtn").disabled = false;

      if (answered >= currentQuestions.length) {
        finishTest(false);
      }
    }

    function updateScoreline() {
      const pct = answered > 0 ? Math.round((score / answered) * 100) : 0;
      document.getElementById("scoreline").textContent = `Punkte: ${score} / ${answered} (${pct}%)`;
    }

    function finishTest(byTime) {
      clearInterval(timerInterval);
      const pct = answered > 0 ? Math.round((score / answered) * 100) : 0;
      const box = document.getElementById("finalBox");
      box.classList.remove("hidden");
      box.textContent = byTime
        ? `Zeit abgelaufen. Ergebnis: ${score} von ${answered} (${pct}%).`
        : `Test beendet. Ergebnis: ${score} von ${answered} (${pct}%).`;
    }

    document.getElementById("nextBtn").onclick = () => {
      if (currentIndex < currentQuestions.length - 1) {
        currentIndex++;
        renderQuestion();
      } else {
        finishTest(false);
      }
    };

    document.getElementById("restartBtn").onclick = () => {
      startNewTest();
    };

    document.getElementById("showSolutionBtn").onclick = () => {
      const q = currentQuestions[currentIndex];
      const esel = document.getElementById("esel");
      const feedback = document.getElementById("inputFeedback");

      esel.textContent = q.esel || "Hinweis: siehe BWL-Skript zum Kapitel.";

      if (q.typ === "calc" && typeof q.loesungNumerisch !== "undefined") {
        feedback.innerHTML = "Lösung: <strong>" + q.loesungNumerisch + "</strong>";
        feedback.style.color = "#e2e8f0";
      } else if (Array.isArray(q.korrekteAntworten) && q.korrekteAntworten.length > 0) {
        feedback.innerHTML = "Lösungsmöglichkeiten:<br>- " + q.korrekteAntworten.join("<br>- ");
        feedback.style.color = "#e2e8f0";
      } else if (Array.isArray(q.schluesselwoerter) && q.schluesselwoerter.length > 0) {
        feedback.innerHTML = "Das musste vorkommen:<br>- " + q.schluesselwoerter.join("<br>- ");
        feedback.style.color = "#e2e8f0";
      }
    };

    document.getElementById("showExplainBtn").onclick = () => {
      const q = currentQuestions[currentIndex];
      const overlay = document.getElementById("explainOverlay");
      const text = document.getElementById("explainText");
      const title = document.getElementById("explainTitle");

      title.textContent = q.tag ? `Erklärung – ${q.tag}` : "Erklärung";

      if (q.erklaerung) {
        text.textContent = q.erklaerung;
      } else {
        text.textContent = "Zu dieser Frage ist noch keine Erklärung hinterlegt. Ergänze in bwl_test.json das Feld \"erklaerung\".";
      }

      overlay.style.display = "flex";
    };

    document.getElementById("closeExplainBtn").onclick = () => {
      document.getElementById("explainOverlay").style.display = "none";
    };

    document.getElementById("exportBtn").onclick = () => {
      const header = "id;frage;user;korrekt;zeit\n";
      const rows = results.map(r => `${r.id};"${r.frage.replace(/"/g,'""')}";"${(r.user||"").replace(/"/g,'""')}";${r.korrekt};${r.zeit}`).join("\n");
      const csv = header + rows;
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = RESULTS_FILENAME;
      a.click();
      URL.revokeObjectURL(url);
    };

    loadQuestions();
  </script>
</body>
</html>
