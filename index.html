<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>LernApp – Deine Tests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Futuristische Schrift -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0f172a;         /* dunkelblau */
      --card: #1e293b;
      --border: #334155;
      --accent: #38bdf8;     /* cyan/blau */
      --good: #22c55e;
      --bad: #ef4444;
      --text: #e2e8f0;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
    }

    .hidden {
      display: none;
    }

    .app {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px 20px;
      width: min(900px, 100%);
      box-shadow: 0 20px 40px rgba(0,0,0,.25);
      position: relative;
    }

    /* HOME SCREEN */
    #homeScreen {
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 24px;
      align-items: center;
      justify-content: center;
      min-height: 520px;
    }

    /* Buttons auf der Startseite */
    .test-list {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      width: 100%;
    }

    .test-list button {
      position: relative;
      overflow: hidden;
      width: 70%;
      max-width: 520px;
      height: 56px;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      white-space: nowrap;
      background: #f8f7f3; /* eierschalen-weiß, aber auf blau gut lesbar */
      color: #111;
      font-weight: 700;
      font-family: 'Orbitron', sans-serif;
      border: none;
      border-radius: 9999px;
      padding: 0 20px;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(255,255,255,0.15);
      transition: all 0.3s ease;
    }

    .test-list button::before {
      content: "";
      position: absolute;
      top: 0;
      left: -75%;
      width: 50%;
      height: 100%;
      background: linear-gradient(
        120deg,
        rgba(255, 255, 255, 0.35),
        rgba(255, 255, 255, 0)
      );
      transform: skewX(-25deg);
    }

    .test-list button:hover::before {
      animation: shine 1.5s forwards;
    }

    @keyframes shine {
      0% { left: -75%; }
      100% { left: 125%; }
    }

    .test-list button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 25px rgba(255,255,255,0.4);
      background: #ffffff;
    }

    .test-list button:active {
      transform: scale(0.97);
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .title {
      font-weight: 700;
      font-size: 1rem;
    }

    .timer {
      background: rgba(248, 113, 113, 0.08);
      border: 1px solid rgba(248, 113, 113, 0.3);
      border-radius: 9999px;
      padding: 4px 12px;
      font-weight: 600;
      min-width: 70px;
      text-align: center;
    }

    .info-line {
      font-size: .8rem;
      opacity: .75;
      margin-bottom: 12px;
    }

    .question-box {
      background: rgba(15,23,42,.3);
      border: 1px solid rgba(148,163,184,.1);
      border-radius: 12px;
      padding: 14px 14px 10px 14px;
      margin-bottom: 14px;
    }

    .tag {
      text-transform: uppercase;
      letter-spacing: .12em;
      font-size: .65rem;
      opacity: .6;
      margin-bottom: .35rem;
    }

    .frage {
      font-size: 1.05rem;
      font-weight: 600;
      margin-bottom: .75rem;
    }

    .input-box, .mc-box {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 10px;
      margin-bottom: .75rem;
    }

    .input-box input {
      width: 100%;
      background: rgba(15,23,42,0);
      border: 1px solid rgba(148,163,184,.35);
      border-radius: 8px;
      padding: 7px 9px;
      color: #e2e8f0;
      outline: none;
    }

    .mc-option {
      display: block;
      width: 100%;
      text-align: left;
      background: rgba(15,23,42,.5);
      border: 1px solid rgba(148,163,184,.2);
      border-radius: 10px;
      padding: 8px 10px;
      margin-bottom: 6px;
      cursor: pointer;
      color: #e2e8f0;
      font-weight: 500;
    }

    .buttons {
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
      margin-top: .5rem;
    }

    button {
      background: var(--accent);
      border: none;
      border-radius: 9999px;
      padding: 8px 14px;
      font-weight: 600;
      cursor: pointer;
      color: #0f172a;
    }

    button.secondary {
      background: transparent;
      border: 1px solid var(--accent);
      color: #e2e8f0;
    }

    button.danger {
      background: var(--bad);
      color: #0f172a;
    }

    button:disabled {
      opacity: .45;
      cursor: not-allowed;
    }

    .scoreline {
      font-size: .8rem;
      margin-top: .6rem;
      opacity: .75;
    }

    .finished {
      font-size: 1.1rem;
      font-weight: 600;
      margin-top: 1rem;
    }

    .esel {
      margin-top: .5rem;
      font-size: .75rem;
      opacity: .7;
    }

    /* Erklärung-Popup */
    #explainOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.75);
      backdrop-filter: blur(2px);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #explainBox {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 14px;
      max-width: 620px;
      width: 92%;
      padding: 16px 18px;
    }
  </style>
</head>
<body>
  <div class="app">

    <!-- STARTSEITE -->
    <div id="homeScreen">
      <div style="font-size:32px; color:#38bdf8; text-shadow:0 0 15px rgba(56,189,248,0.5); font-family:'Orbitron',sans-serif; line-height:1.3; opacity:0; transform:translateY(-15px); animation:fadeInTop 1.3s ease-out forwards;">
        Willkommen Meister,<br>
        It´s time to lean!
      </div>

      <div class="test-list">
        <button onclick="selectTest('bwl')">Grundlagen der Betriebswirtschaftslehre</button>
        <button onclick="selectTest('fall')">Die Systematik der Fallbearbeitung</button>
      </div>

      <div style="font-size:24px; margin-top:2rem; color:#38bdf8; opacity:0; transform:translateY(15px); animation:fadeInBottom 1.3s ease-out forwards; animation-delay:.4s; font-family:'Orbitron',sans-serif;">
        Weitere Tests folgen, sobald du deine Hefte fertig gelesen hast!!<br>
        Also häng dich rein, mein Bester.
      </div>
    </div>

    <!-- TEST-SCREEN -->
    <div id="testScreen" class="hidden">
      <div class="topbar">
        <div class="title" id="testTitle">Test</div>
        <div id="timer" class="timer">90:00</div>
      </div>
      <div class="info-line" id="infoLine">Frage 1 von 20 · 90 Minuten Prüfungszeit.</div>
      <div id="questionBox" class="question-box">
        <div id="tag" class="tag"></div>
        <div id="frage" class="frage"></div>

        <div id="inputBox" class="input-box hidden">
          <input id="userInput" type="text" placeholder="Antwort eingeben …" />
          <button id="checkInputBtn" style="margin-top:6px;">Prüfen</button>
          <div id="inputFeedback" class="feedback"></div>
        </div>

        <div id="mcBox" class="mc-box hidden"></div>

        <div id="esel" class="esel"></div>
      </div>
      <div class="buttons">
        <button id="backHomeBtn" class="secondary">Zur Startseite</button>
        <button id="nextBtn" class="secondary">Nächste Frage</button>
        <button id="showSolutionBtn" class="secondary">Lösung anzeigen</button>
        <button id="showExplainBtn" class="secondary" disabled>Erklärung</button>
        <button id="restartBtn" class="danger">Test neu starten</button>
        <button id="exportBtn" class="secondary">Ergebnisse exportieren</button>
      </div>
      <div id="scoreline" class="scoreline">Punkte: 0 / 0 (0%)</div>
      <div id="finalBox" class="finished hidden"></div>
    </div>
  </div>

  <!-- Erklärung-Popup -->
  <div id="explainOverlay">
    <div id="explainBox">
      <div id="explainTitle" style="font-weight:600; margin-bottom:6px;">Erklärung</div>
      <div id="explainText" style="font-size:.85rem; line-height:1.4;"></div>
      <button id="closeExplainBtn" style="margin-top:12px; background:#38bdf8; border:none; border-radius:9999px; padding:6px 12px; font-weight:600; cursor:pointer; color:#0f172a;">Schließen</button>
    </div>
  </div>

  <style>
    @keyframes fadeInTop {
      0% { opacity:0; transform:translateY(-15px); }
      100% { opacity:1; transform:translateY(0); }
    }
    @keyframes fadeInBottom {
      0% { opacity:0; transform:translateY(15px); }
      100% { opacity:1; transform:translateY(0); }
    }
  </style>

  <script>
    // Konfiguration
    const MAX_TIME_SECONDS = 90 * 60; // 90 Minuten
    // wir nehmen die Anzahl aus dem gewählten Test

    // alle Tests hier eintragen
    const TESTS = {
      bwl: {
        name: "Grundlagen der Betriebswirtschaftslehre – Test",
        file: "bwl_test.json",
        questionCount: 20
      },
      fall: {
        name: "Die Systematik der Fallbearbeitung – Test",
        file: "fallbearbeitung_test.json",
        questionCount: 35
      }
    };

    // State
    let selectedTest = null;
    let allQuestions = [];
    let currentQuestions = [];
    let currentIndex = 0;
    let score = 0;
    let answered = 0;
    let timerInterval = null;
    let secondsLeft = MAX_TIME_SECONDS;
    let results = []; // {id, frage, user, korrekt, zeit}

    // Test auswählen
    async function selectTest(key) {
      const t = TESTS[key];
      if (!t) return;
      selectedTest = t;

      document.getElementById("homeScreen").classList.add("hidden");
      document.getElementById("testScreen").classList.remove("hidden");
      document.getElementById("testTitle").textContent = t.name;

      await loadQuestions();
      startNewTest();
    }

    // Fragen laden
    async function loadQuestions() {
      const res = await fetch(selectedTest.file);
      allQuestions = await res.json();
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function startNewTest() {
      score = 0;
      answered = 0;
      results = [];
      document.getElementById("finalBox").classList.add("hidden");

      const copy = [...allQuestions];
      shuffle(copy);
      currentQuestions = copy.slice(0, selectedTest.questionCount);
      currentIndex = 0;

      if (timerInterval) clearInterval(timerInterval);
      secondsLeft = MAX_TIME_SECONDS;
      updateTimer();
      timerInterval = setInterval(tick, 1000);

      renderQuestion();
      updateScoreline();
    }

    function tick() {
      secondsLeft--;
      updateTimer();
      if (secondsLeft <= 0) {
        clearInterval(timerInterval);
        finishTest(true);
      }
    }

    function updateTimer() {
      const m = Math.floor(secondsLeft / 60);
      const s = secondsLeft % 60;
      document.getElementById("timer").textContent =
        `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    }

    function renderQuestion() {
      const q = currentQuestions[currentIndex];
      if (!q) return;

      document.getElementById("tag").textContent = q.tag || "";
      document.getElementById("frage").textContent = q.frage;
      document.getElementById("esel").textContent = q.esel || "";
      document.getElementById("infoLine").textContent =
        `Frage ${currentIndex + 1} von ${currentQuestions.length} · 90 Minuten Prüfungszeit.`;

      // Felder aufräumen
      const inputBox = document.getElementById("inputBox");
      const mcBox = document.getElementById("mcBox");
      const inputFeedback = document.getElementById("inputFeedback");
      const userInput = document.getElementById("userInput");

      inputBox.classList.add("hidden");
      mcBox.classList.add("hidden");
      mcBox.innerHTML = "";
      inputFeedback.textContent = "";
      if (userInput) userInput.value = "";

      document.getElementById("showExplainBtn").disabled = true;

      if (q.typ === "mc") {
        renderMC(q);
      } else {
        renderInput(q);
      }
    }

    function renderMC(q) {
      const inputBox = document.getElementById("inputBox");
      inputBox.classList.add("hidden");

      const box = document.getElementById("mcBox");
      box.innerHTML = "";
      box.classList.remove("hidden");

      const options = shuffle([...q.optionen]);
      options.forEach(opt => {
        const btn = document.createElement("button");
        btn.textContent = opt;
        btn.className = "mc-option";
        btn.onclick = () => {
          const richtig = normalize(opt) === normalize(q.loesung);
          handleAnswer(q, opt, richtig);
          btn.style.background = richtig ? "rgba(34,197,94,.4)" : "rgba(239,68,68,.4)";
          btn.style.color = "#0f172a";
        };
        box.appendChild(btn);
      });
    }

    function renderInput(q) {
      const mcBox = document.getElementById("mcBox");
      mcBox.innerHTML = "";
      mcBox.classList.add("hidden");

      const inputBox = document.getElementById("inputBox");
      const feedback = document.getElementById("inputFeedback");
      const userInput = document.getElementById("userInput");

      inputBox.classList.remove("hidden");
      feedback.textContent = "";
      feedback.style.color = "#e2e8f0";
      userInput.value = "";

      document.getElementById("checkInputBtn").onclick = () => {
        const val = userInput.value.trim();
        const richtig = checkInputAnswer(q, val);
        handleAnswer(q, val, richtig);

        if (richtig) {
          feedback.textContent = "Richtig ✅";
          feedback.style.color = "#22c55e";
        } else {
          feedback.style.textAlign = "left";
          feedback.style.color = "#ef4444";

          if (q.typ === "calc" && typeof q.loesungNumerisch !== "undefined") {
            feedback.innerHTML = "Nicht ganz ❌<br>Richtige Lösung: <strong>" + q.loesungNumerisch + "</strong>";
          } else if (Array.isArray(q.korrekteAntworten) && q.korrekteAntworten.length > 0) {
            feedback.innerHTML = "Nicht ganz ❌<br>Mögliche richtige Lösungen:<br>- " + q.korrekteAntworten.join("<br>- ");
          } else if (Array.isArray(q.schluesselwoerter) && q.schluesselwoerter.length > 0) {
            feedback.innerHTML = "Nicht ganz ❌<br>Das musste vorkommen:<br>- " + q.schluesselwoerter.join("<br>- ");
          } else {
            feedback.textContent = "Nicht ganz ❌";
          }
        }
      };
    }

    function normalize(str) {
      return (str || "")
        .toString()
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[.,;:!?]/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function checkInputAnswer(q, userVal) {
      if (q.typ === "calc") {
        const num = parseFloat((userVal || "").replace(",", "."));
        if (isNaN(num)) return false;
        const tol = q.toleranz || 0;
        return Math.abs(num - q.loesungNumerisch) <= tol;
      }

      const userNorm = normalize(userVal);

      if (q.schluesselwoerter && q.schluesselwoerter.length > 0) {
        let ok = 0;
        for (const kw of q.schluesselwoerter) {
          const kwNorm = normalize(kw);
          if (userNorm.includes(kwNorm)) {
            ok++;
          } else {
            const parts = userNorm.split(" ");
            const near = parts.some(p => editDistance(p, kwNorm) <= 1);
            if (near) ok++;
          }
        }
        return ok === q.schluesselwoerter.length;
      }

      if (q.korrekteAntworten && q.korrekteAntworten.length > 0) {
        return q.korrekteAntworten.some(ans => normalize(ans) === userNorm);
      }

      return false;
    }

    function editDistance(a, b) {
      const dp = Array.from({length: a.length + 1}, () => Array(b.length + 1).fill(0));
      for (let i = 0; i <= a.length; i++) dp[i][0] = i;
      for (let j = 0; j <= b.length; j++) dp[0][j] = j;
      for (let i = 1; i <= a.length; i++) {
        for (let j = 1; j <= b.length; j++) {
          if (a[i-1] === b[j-1]) dp[i][j] = dp[i-1][j-1];
          else dp[i][j] = Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]) + 1;
        }
      }
      return dp[a.length][b.length];
    }

    function handleAnswer(q, userVal, richtig) {
      answered++;
      if (richtig) score++;

      results.push({
        id: q.id,
        frage: q.frage,
        user: userVal,
        korrekt: richtig ? "ja" : "nein",
        zeit: new Date().toISOString()
      });

      updateScoreline();
      document.getElementById("showExplainBtn").disabled = false;

      if (answered >= currentQuestions.length) {
        finishTest(false);
      }
    }

    function updateScoreline() {
      const pct = answered > 0 ? Math.round((score / answered) * 100) : 0;
      document.getElementById("scoreline").textContent =
        `Punkte: ${score} / ${answered} (${pct}%)`;
    }

    function finishTest(byTime) {
      clearInterval(timerInterval);
      const pct = answered > 0 ? Math.round((score / answered) * 100) : 0;
      const box = document.getElementById("finalBox");
      box.classList.remove("hidden");
      box.textContent = byTime
        ? `Zeit abgelaufen. Ergebnis: ${score} von ${answered} (${pct}%).`
        : `Test beendet. Ergebnis: ${score} von ${answered} (${pct}%).`;
    }

    // Buttons
    document.getElementById("nextBtn").onclick = () => {
      if (currentIndex < currentQuestions.length - 1) {
        currentIndex++;
        renderQuestion();
      } else {
        finishTest(false);
      }
    };

    document.getElementById("restartBtn").onclick = () => {
      startNewTest();
    };

    document.getElementById("backHomeBtn").onclick = () => {
      clearInterval(timerInterval);
      document.getElementById("testScreen").classList.add("hidden");
      document.getElementById("homeScreen").classList.remove("hidden");
    };

    document.getElementById("showSolutionBtn").onclick = () => {
      const q = currentQuestions[currentIndex];
      const esel = document.getElementById("esel");
      const feedback = document.getElementById("inputFeedback");

      esel.textContent = q.esel || "Hinweis: siehe Skript.";

      if (q.typ === "calc" && typeof q.loesungNumerisch !== "undefined") {
        feedback.innerHTML = "Lösung: <strong>" + q.loesungNumerisch + "</strong>";
        feedback.style.color = "#e2e8f0";
      } else if (Array.isArray(q.korrekteAntworten) && q.korrekteAntworten.length > 0) {
        feedback.innerHTML = "Lösungsmöglichkeiten:<br>- " + q.korrekteAntworten.join("<br>- ");
        feedback.style.color = "#e2e8f0";
      } else if (Array.isArray(q.schluesselwoerter) && q.schluesselwoerter.length > 0) {
        feedback.innerHTML = "Das musste vorkommen:<br>- " + q.schluesselwoerter.join("<br>- ");
        feedback.style.color = "#e2e8f0";
      }
    };

    document.getElementById("showExplainBtn").onclick = () => {
      const q = currentQuestions[currentIndex];
      const overlay = document.getElementById("explainOverlay");
      const text = document.getElementById("explainText");
      const title = document.getElementById("explainTitle");

      title.textContent = q.tag ? `Erklärung – ${q.tag}` : "Erklärung";

      if (q.erklaerung) {
        text.textContent = q.erklaerung;
      } else {
        text.textContent = "Zu dieser Frage ist noch keine Erklärung hinterlegt.";
      }

      overlay.style.display = "flex";
    };

    document.getElementById("closeExplainBtn").onclick = () => {
      document.getElementById("explainOverlay").style.display = "none";
    };

    // TXT-Export
    document.getElementById("exportBtn").onclick = () => {
      const lines = results.map((r, idx) => {
        const frage = r.frage || "—";
        const antwort = (r.user && r.user !== "") ? r.user : "keine Antwort";
        return `Frage ${idx + 1}: ${frage}\nAntwort: ${antwort}`;
      });

      const header = `Ergebnisexport – ${new Date().toLocaleString("de-DE")}\nTest: ${(selectedTest && selectedTest.name) || ""}\nAnzahl beantworteter Fragen: ${results.length}\n\n`;
      const content = header + lines.join("\n\n");

      const blob = new Blob([content], { type: "text/plain" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "test_ergebnisse.txt";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    // WICHTIG: kein automatisches loadQuestions(), erst nach Testwahl
  </script>
</body>
</html>
