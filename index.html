<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>LernApp – Deine Tests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Futuristische Schrift -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0f172a;         /* dunkelblau */
      --card: #1e293b;
      --border: #334155;
      --accent: #38bdf8;     /* cyan/blau */
      --good: #22c55e;
      --bad: #ef4444;
      --text: #e2e8f0;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
    }

    .hidden { display: none; }

    .app {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px 20px;
      width: min(900px, 100%);
      box-shadow: 0 20px 40px rgba(0,0,0,.25);
      position: relative;
    }

    /* HOME SCREEN */
    #homeScreen {
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 24px;
      align-items: center;
      justify-content: center;
      min-height: 520px;
    }

    .test-list {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      width: 100%;
    }
    .test-list button {
      position: relative;
      overflow: hidden;
      width: 70%;
      max-width: 520px;
      height: 56px;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      white-space: nowrap;
      background: #f8f7f3;
      color: #111;
      font-weight: 700;
      font-family: 'Orbitron', sans-serif;
      border: none;
      border-radius: 9999px;
      padding: 0 20px;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(255,255,255,0.15);
      transition: all 0.3s ease;
    }
    .test-list button::before {
      content: "";
      position: absolute;
      top: 0;
      left: -75%;
      width: 50%;
      height: 100%;
      background: linear-gradient(120deg, rgba(255,255,255,0.35), rgba(255,255,255,0));
      transform: skewX(-25deg);
    }
    .test-list button:hover::before { animation: shine 1.5s forwards; }
    @keyframes shine { 0% { left: -75%; } 100% { left: 125%; } }
    .test-list button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 25px rgba(255,255,255,0.4);
      background: #ffffff;
    }
    .test-list button:active { transform: scale(0.97); }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .title { font-weight: 700; font-size: 1rem; }
    .timer {
      background: rgba(248, 113, 113, 0.08);
      border: 1px solid rgba(248, 113, 113, 0.3);
      border-radius: 9999px;
      padding: 4px 12px;
      font-weight: 600;
      min-width: 70px;
      text-align: center;
    }
    .info-line { font-size: .8rem; opacity: .75; margin-bottom: 12px; }

    .question-box {
      background: rgba(15,23,42,.3);
      border: 1px solid rgba(148,163,184,.1);
      border-radius: 12px;
      padding: 14px 14px 10px 14px;
      margin-bottom: 14px;
    }
    .tag {
      text-transform: uppercase;
      letter-spacing: .12em;
      font-size: .65rem;
      opacity: .6;
      margin-bottom: .35rem;
    }
    .frage { font-size: 1.05rem; font-weight: 600; margin-bottom: .75rem; }

    .input-box, .mc-box, .match-box, .order-box, .justify-box, .fall-box {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 10px;
      margin-bottom: .75rem;
    }
    .input-box input, .justify-box textarea, .fall-box textarea {
      width: 100%;
      background: rgba(15,23,42,0);
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 7px 9px;
      color: #e2e8f0;
      outline: none;
    }
    .justify-box textarea, .fall-box textarea {
      min-height: 100px;
      resize: vertical;
    }

    .mc-option {
      display: block;
      width: 100%;
      text-align: left;
      background: rgba(15,23,42,.5);
      border: 1px solid rgba(148,163,184,.2);
      border-radius: 10px;
      padding: 8px 10px;
      margin-bottom: 6px;
      cursor: pointer;
      color: #e2e8f0;
      font-weight: 500;
    }

    .pair-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }
    .pair-row .left {
      background: rgba(148,163,184,0.08);
      border: 1px solid rgba(148,163,184,0.2);
      border-radius: 8px;
      padding: 6px 8px;
      font-size: .9rem;
    }
    .pair-row select {
      width: 100%;
      background: #020617;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 6px 8px;
      color: #e2e8f0;
    }

    .order-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      background: rgba(148,163,184,0.08);
      border: 1px solid rgba(148,163,184,0.2);
      border-radius: 8px;
      padding: 8px;
      margin-bottom: 6px;
    }
    .order-item .txt { flex: 1; }
    .order-item .btns button {
      background: transparent;
      border: 1px solid var(--accent);
      color: #e2e8f0;
      border-radius: 9999px;
      padding: 4px 10px;
      cursor: pointer;
    }

    .buttons { display: flex; gap: .5rem; flex-wrap: wrap; margin-top: .5rem; }
    button {
      background: var(--accent);
      border: none;
      border-radius: 9999px;
      padding: 8px 14px;
      font-weight: 600;
      cursor: pointer;
      color: #0f172a;
    }
    button.secondary { background: transparent; border: 1px solid var(--accent); color: #e2e8f0; }
    button.danger { background: var(--bad); color: #0f172a; }
    button:disabled { opacity: .45; cursor: not-allowed; }

    .scoreline { font-size: .8rem; margin-top: .6rem; opacity: .75; }
    .finished { font-size: 1.1rem; font-weight: 600; margin-top: 1rem; }
    .esel { margin-top: .5rem; font-size: .75rem; opacity: .7; }

    /* Erklärung-Popup */
    #explainOverlay {
      display: none; position: fixed; inset: 0;
      background: rgba(15,23,42,.75);
      backdrop-filter: blur(2px);
      justify-content: center; align-items: center; z-index: 9999;
    }
    #explainBox {
      background: #0f172a; border: 1px solid #334155; border-radius: 14px;
      max-width: 620px; width: 92%; padding: 16px 18px;
    }

    /* Taschenrechner-Overlay */
    #calcOverlay {
      display: none; position: fixed; inset: 0;
      background: rgba(15,23,42,.7);
      backdrop-filter: blur(2px);
      justify-content: center; align-items: center; z-index: 9999;
    }

    @keyframes fadeInTop { 0%{opacity:0; transform:translateY(-15px);} 100%{opacity:1; transform:translateY(0);} }
    @keyframes fadeInBottom { 0%{opacity:0; transform:translateY(15px);} 100%{opacity:1; transform:translateY(0);} }
  </style>
</head>
<body>
  <div class="app">

    <!-- STARTSEITE -->
    <div id="homeScreen">
      <div style="font-size:32px; color:#38bdf8; text-shadow:0 0 15px rgba(56,189,248,0.5); font-family:'Orbitron',sans-serif; line-height:1.3; opacity:0; transform:translateY(-15px); animation:fadeInTop 1.3s ease-out forwards;">
        Willkommen Meister,<br>
        It´s time to lean!
      </div>

      <div class="test-list">
        <button onclick="selectTest('bwl')">1. Grundlagen der Betriebswirtschaftslehre</button>
        <button onclick="selectTest('fall')">2. Die Systematik der Fallbearbeitung</button>
        <button onclick="selectTest('rwb')">3. BGB-Grundlagen</button>
      </div>

      <div style="font-size:24px; margin-top:2rem; color:#38bdf8; opacity:0; transform:translateY(15px); animation:fadeInBottom 1.3s ease-out forwards; animation-delay:.4s; font-family:'Orbitron',sans-serif;">
        Weitere Tests folgen, sobald du deine Hefte fertig gelesen hast!!<br>
        Also häng dich rein, mein Bester.
      </div>
    </div>

    <!-- TEST-SCREEN -->
    <div id="testScreen" class="hidden">
      <div class="topbar">
        <div class="title" id="testTitle">Test</div>
        <div id="timer" class="timer">90:00</div>
      </div>
      <div class="info-line" id="infoLine">Frage 1 von 20 · 90 Minuten Prüfungszeit.</div>

      <div id="questionBox" class="question-box">
        <div id="tag" class="tag"></div>
        <div id="frage" class="frage"></div>

        <!-- TEXT-EINGABE / CALC -->
        <div id="inputBox" class="input-box hidden">
          <input id="userInput" type="text" placeholder="Antwort eingeben …" />
          <div style="display:flex; gap:8px; margin-top:6px;">
            <button id="checkInputBtn">Prüfen</button>
            <button id="openCalcBtn" class="secondary" style="display:none;">Rechner</button>
          </div>
          <div id="inputFeedback" class="feedback" style="margin-top:6px;"></div>
        </div>

        <!-- MC -->
        <div id="mcBox" class="mc-box hidden"></div>

        <!-- MATCH (Zuordnung) -->
        <div id="matchBox" class="match-box hidden">
          <div id="matchRows"></div>
          <button id="checkMatchBtn" class="secondary" style="margin-top:6px;">Prüfen</button>
          <div id="matchFeedback" style="margin-top:6px;"></div>
        </div>

        <!-- ORDER (Reihenfolge) -->
        <div id="orderBox" class="order-box hidden">
          <div id="orderList"></div>
          <div style="display:flex; gap:8px; margin-top:6px;">
            <button id="shuffleOrderBtn" class="secondary">Neu mischen</button>
            <button id="checkOrderBtn">Prüfen</button>
          </div>
          <div id="orderFeedback" style="margin-top:6px;"></div>
        </div>

        <!-- JUSTIFY -->
        <div id="justifyBox" class="justify-box hidden">
          <textarea id="justifyText" placeholder="Kurz begründen… (Stichwörter zählen)"></textarea>
          <div style="display:flex; gap:8px; margin-top:6px;">
            <button id="checkJustifyBtn">Prüfen</button>
          </div>
          <div id="justifyFeedback" style="margin-top:6px;"></div>
        </div>

        <!-- FALLANALYSE -->
        <div id="fallBox" class="fall-box hidden">
          <textarea id="fallText" placeholder="Kurze Lösung in Stichpunkten…"></textarea>
          <div style="display:flex; gap:8px; margin-top:6px;">
            <button id="checkFallBtn">Prüfen</button>
          </div>
          <div id="fallFeedback" style="margin-top:6px;"></div>
        </div>

        <div id="esel" class="esel"></div>
      </div>

      <div class="buttons">
        <button id="backHomeBtn" class="secondary">Zur Startseite</button>
        <button id="nextBtn" class="secondary">Nächste Frage</button>
        <button id="showSolutionBtn" class="secondary">Lösung anzeigen</button>
        <button id="showExplainBtn" class="secondary" disabled>Erklärung</button>
        <button id="restartBtn" class="danger">Test neu starten</button>
        <button id="exportBtn" class="secondary">Ergebnisse exportieren</button>
      </div>
      <div id="scoreline" class="scoreline">Punkte: 0 / 0 (0%)</div>
      <div id="finalBox" class="finished hidden"></div>
    </div>
  </div>

  <!-- Erklärung-Popup -->
  <div id="explainOverlay">
    <div id="explainBox">
      <div id="explainTitle" style="font-weight:600; margin-bottom:6px;">Erklärung</div>
      <div id="explainText" style="font-size:.85rem; line-height:1.4;"></div>

      <!-- QUELLEN -->
      <div id="explainSourcesWrap" style="margin-top:10px; display:none;">
        <div style="font-size:.7rem; text-transform:uppercase; letter-spacing:.08em; opacity:.6; margin-bottom:4px;">Quellen / Nachlesen</div>
        <div id="explainSources" style="display:flex; flex-direction:column; gap:4px;"></div>
      </div>

      <button id="closeExplainBtn" style="margin-top:12px; background:#38bdf8; border:none; border-radius:9999px; padding:6px 12px; font-weight:600; cursor:pointer; color:#0f172a;">Schließen</button>
    </div>
  </div>

  <!-- TASCHENRECHNER-POPUP -->
  <div id="calcOverlay">
    <div style="background:#0f172a; border:1px solid #334155; border-radius:14px; padding:14px; width:280px;">
      <div style="font-weight:600; margin-bottom:6px;">Taschenrechner</div>
      <input id="calcDisplay" type="text" value="" style="width:100%; background:#020617; border:1px solid #334155; border-radius:8px; padding:6px 8px; color:#e2e8f0; margin-bottom:8px;">
      <div style="font-size:.7rem; opacity:.55; margin-bottom:6px;">Numpad benutzen oder direkt tippen. Enter = übernehmen.</div>
      <button id="closeCalcBtn" class="secondary" style="width:auto;">Schließen</button>
    </div>
  </div>

  <script>
    // =============================
    // Konfiguration
    // =============================
    const MAX_TIME_SECONDS = 90 * 60; // 90 Minuten

    const TESTS = {
      rwb: {
        name: "3. BGB-Grundlagen (RWB) – Test",
        file: "rwb_test.json",      // <<-- bleibt bewusst so
        questionCount: 35
      },
      bwl: {
        name: "1. Grundlagen der Betriebswirtschaftslehre – Test",
        file: "bwl_test.json",
        questionCount: 20
      },
      fall: {
        name: "2. Die Systematik der Fallbearbeitung – Test",
        file: "fallbearbeitung_test.json",
        questionCount: 35
      }
    };

    // =============================
    // State
    // =============================
    let selectedTest = null;
    let allQuestions = [];
    let currentQuestions = [];
    let currentIndex = 0;
    let score = 0;
    let answered = 0;
    let timerInterval = null;
    let secondsLeft = MAX_TIME_SECONDS;
    let results = []; // {id, frage, user, korrekt, zeit}
    let calcOpen = false;

    // =============================
    // Dedupe-Utilities (NEU)
    // =============================
    function nrm(s){
      return (s||"").toString().toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/\s+/g," ").trim();
    }

    function keyForQuestion(q){
      const base = [q.typ||"", nrm(q.frage||""), nrm(q.tag||"")];

      if(q.typ==="mc"){
        const opts = Array.isArray(q.optionen)? [...q.optionen].map(nrm).sort().join("|") : "";
        base.push("mc", opts, nrm(q.loesung||""));
      } else if(q.typ==="input"){
        const kor = Array.isArray(q.korrekteAntworten)? [...q.korrekteAntworten].map(nrm).sort().join("|") : "";
        base.push("input", kor);
      } else if(q.typ==="match"){
        const pairs = q.paare? Object.entries(q.paare).map(([l,r])=> `${nrm(l)}=>${nrm(r)}`).sort().join("|") : "";
        base.push("match", pairs);
      } else if(q.typ==="order"){
        const seq = Array.isArray(q.richtigeReihenfolge)? q.richtigeReihenfolge.map(nrm).join("|") : "";
        base.push("order", seq);
      } else if(q.typ==="justify" || q.typ==="fallanalyse"){
        const keys = (q.stichwoerter||q.stichpunkte||[]).map(nrm).sort().join("|");
        base.push(q.typ, keys);
      } else if(q.typ==="calc"){
        base.push("calc", String(q.formel||""));
      }
      return base.join("§");
    }

    function dedupeQuestions(list){
      const seen = new Map();
      for(const q of list){
        const k = keyForQuestion(q);
        if(!seen.has(k)) seen.set(k, q);
      }
      return Array.from(seen.values());
    }

    // =============================
    // Test auswählen / laden
    // =============================
    async function selectTest(key) {
      const t = TESTS[key];
      if (!t) return;
      selectedTest = t;

      document.getElementById("homeScreen").classList.add("hidden");
      document.getElementById("testScreen").classList.remove("hidden");
      document.getElementById("testTitle").textContent = t.name;

      await loadQuestions();
      startNewTest();
    }

    async function loadQuestions() {
      const res = await fetch(selectedTest.file);
      const raw = await res.json();
      const hard = dedupeQuestions(Array.isArray(raw)? raw : []);
      if (hard.length !== raw.length) {
        console.warn(`Dedupe: ${raw.length - hard.length} Duplikate entfernt (${selectedTest.file}).`);
      }
      allQuestions = hard;
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function startNewTest() {
      score = 0;
      answered = 0;
      results = [];
      document.getElementById("finalBox").classList.add("hidden");

      const copy = shuffle([...allQuestions]);

      // Einzigartige Auswahl nach inhaltlichem Schlüssel
      const want = selectedTest.questionCount;
      const picked = [];
      const pickedKeys = new Set();
      for (const q of copy) {
        const k = keyForQuestion(q);
        if (!pickedKeys.has(k)) {
          picked.push(q);
          pickedKeys.add(k);
          if (picked.length === want) break;
        }
      }
      if (picked.length < want) {
        console.warn(`Nur ${picked.length} einzigartige Fragen gefunden, gewünscht ${want}.`);
      }

      currentQuestions = picked;
      currentIndex = 0;

      if (timerInterval) clearInterval(timerInterval);
      secondsLeft = MAX_TIME_SECONDS;
      updateTimer();
      timerInterval = setInterval(tick, 1000);

      renderQuestion();
      updateScoreline();
    }

    function tick() {
      secondsLeft--;
      updateTimer();
      if (secondsLeft <= 0) {
        clearInterval(timerInterval);
        finishTest(true);
      }
    }

    function updateTimer() {
      const m = Math.floor(secondsLeft / 60);
      const s = secondsLeft % 60;
      document.getElementById("timer").textContent =
        `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    }

    // =============================
    // Render-Logik (alle Typen)
    // =============================
    function renderQuestion() {
      const q = currentQuestions[currentIndex];
      if (!q) return;

      document.getElementById("tag").textContent = q.tag || "";
      document.getElementById("frage").textContent = q.frage;
      document.getElementById("esel").textContent = q.esel || "";
      document.getElementById("infoLine").textContent =
        `Frage ${currentIndex + 1} von ${currentQuestions.length} · 90 Minuten Prüfungszeit.`;

      // Inline-Quelle vom Vorgänger entfernen
      document.getElementById("srcInline")?.remove();

      // alle Boxen zurücksetzen
      hideAllBoxes();

      // Erklärung deaktivieren bis geantwortet
      document.getElementById("showExplainBtn").disabled = true;

      switch (q.typ) {
        case "mc":      renderMC(q); break;
        case "input":   renderInput(q); break;
        case "calc":    renderInput(q); break; // gleiche UI, anderes Checking
        case "match":   renderMatch(q); break;
        case "order":   renderOrder(q); break;
        case "justify": renderJustify(q); break;
        case "fallanalyse": renderFall(q); break;
        default:        renderInput(q);
      }
    }

    function hideAllBoxes() {
      const boxes = ["inputBox","mcBox","matchBox","orderBox","justifyBox","fallBox"];
      boxes.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.add("hidden");
        const fb = el.querySelector(".feedback");
        if (fb) fb.textContent = "";
      });
      const ids = ["inputFeedback","matchFeedback","orderFeedback","justifyFeedback","fallFeedback"];
      ids.forEach(id => { const e = document.getElementById(id); if (e) e.innerHTML = ""; });
      document.getElementById("mcBox").innerHTML = "";
      const mr = document.getElementById("matchRows"); if (mr) mr.innerHTML = "";
      const ol = document.getElementById("orderList"); if (ol) ol.innerHTML = "";
      const ui = document.getElementById("userInput"); if (ui) ui.value = "";
      const jt = document.getElementById("justifyText"); if (jt) jt.value = "";
      const ft = document.getElementById("fallText"); if (ft) ft.value = "";
    }

    // ========== MC ==========
    function renderMC(q) {
      const inputBox = document.getElementById("inputBox");
      inputBox.classList.add("hidden");

      const box = document.getElementById("mcBox");
      box.innerHTML = "";
      box.classList.remove("hidden");

      const options = shuffle([...q.optionen]);
      options.forEach(opt => {
        const btn = document.createElement("button");
        btn.textContent = opt;
        btn.className = "mc-option";
        btn.onclick = () => {
          const richtig = normalize(opt) === normalize(q.loesung);
          handleAnswer(q, opt, richtig);
          btn.style.background = richtig ? "rgba(34,197,94,.4)" : "rgba(239,68,68,.4)";
          btn.style.color = "#0f172a";
        };
        box.appendChild(btn);
      });
    }

    // ========== INPUT / CALC ==========
    function renderInput(q) {
      const mcBox = document.getElementById("mcBox");
      mcBox.innerHTML = "";
      mcBox.classList.add("hidden");

      const inputBox = document.getElementById("inputBox");
      const feedback = document.getElementById("inputFeedback");
      const userInput = document.getElementById("userInput");
      const calcBtn = document.getElementById("openCalcBtn");

      inputBox.classList.remove("hidden");
      feedback.textContent = "";
      feedback.style.color = "#e2e8f0";
      userInput.value = "";

      if (q.typ === "calc" || (q.tag && q.tag.toLowerCase().includes("rechnungswesen"))) {
        calcBtn.style.display = "inline-block";
      } else {
        calcBtn.style.display = "none";
      }

      document.getElementById("checkInputBtn").onclick = () => {
        const val = userInput.value.trim();
        const richtig = checkInputAnswer(q, val);
        handleAnswer(q, val, richtig);

        if (richtig) {
          feedback.textContent = "Richtig ✅";
          feedback.style.color = "#22c55e";
        } else {
          feedback.style.textAlign = "left";
          feedback.style.color = "#ef4444";

          if (q.typ === "calc" && typeof q.loesungNumerisch !== "undefined") {
            feedback.innerHTML = "Nicht ganz ❌<br>Richtige Lösung: <strong>" + q.loesungNumerisch + "</strong>";
          } else if (Array.isArray(q.korrekteAntworten) && q.korrekteAntworten.length > 0) {
            feedback.innerHTML = "Nicht ganz ❌<br>Mögliche richtige Lösungen:<br>- " + q.korrekteAntworten.join("<br>- ");
          } else if (Array.isArray(q.schluesselwoerter) && q.schluesselwoerter.length > 0) {
            feedback.innerHTML = "Nicht ganz ❌<br>Das musste vorkommen:<br>- " + q.schluesselwoerter.join("<br>- ");
          } else {
            feedback.textContent = "Nicht ganz ❌";
          }
        }
      };

      document.getElementById("openCalcBtn").onclick = openCalc;
    }

    // ========== MATCH ==========
    function renderMatch(q) {
      const box = document.getElementById("matchBox");
      const rows = document.getElementById("matchRows");
      box.classList.remove("hidden");

      const entries = Object.entries(q.paare || {});
      const lefts = entries.map(e => e[0]);
      const rights = shuffle(entries.map(e => e[1]));

      lefts.forEach((left) => {
        const row = document.createElement("div");
        row.className = "pair-row";
        const l = document.createElement("div");
        l.className = "left";
        l.textContent = left;
        const sel = document.createElement("select");
        rights.forEach(r => {
          const opt = document.createElement("option");
          opt.value = r; opt.textContent = r;
          sel.appendChild(opt);
        });
        sel.dataset.left = left;
        row.appendChild(l);
        row.appendChild(sel);
        rows.appendChild(row);
      });

      document.getElementById("checkMatchBtn").onclick = () => {
        const selects = rows.querySelectorAll("select");
        let allCorrect = true;
        selects.forEach(sel => {
          const left = sel.dataset.left;
          const val = sel.value;
          const isRight = normalize(val) === normalize(q.paare[left] || "");
          sel.style.borderColor = isRight ? "#16a34a" : "#ef4444";
          if (!isRight) allCorrect = false;
        });
        const fb = document.getElementById("matchFeedback");
        if (allCorrect) { fb.textContent = "Alles korrekt ✅"; fb.style.color = "#22c55e"; }
        else { fb.textContent = "Nicht ganz ❌ – prüfe die Zuordnung."; fb.style.color = "#ef4444"; }
        handleAnswer(q, "match_checked", allCorrect);
      };
    }

    // ========== ORDER ==========
    function renderOrder(q) {
      const box = document.getElementById("orderBox");
      const list = document.getElementById("orderList");
      box.classList.remove("hidden");

      const correct = q.richtigeReihenfolge || [];
      let items = shuffle([...correct]);

      function draw() {
        list.innerHTML = "";
        items.forEach((txt, idx) => {
          const row = document.createElement("div");
          row.className = "order-item";
          const t = document.createElement("div");
          t.className = "txt";
          t.textContent = txt;
          const btns = document.createElement("div");
          btns.className = "btns";
          const up = document.createElement("button");
          up.textContent = "↑";
          up.onclick = () => { if (idx>0) { [items[idx-1], items[idx]] = [items[idx], items[idx-1]]; draw(); } };
          const down = document.createElement("button");
          down.textContent = "↓";
          down.onclick = () => { if (idx<items.length-1) { [items[idx+1], items[idx]] = [items[idx], items[idx+1]]; draw(); } };
          btns.appendChild(up); btns.appendChild(down);
          row.appendChild(t); row.appendChild(btns);
          list.appendChild(row);
        });
      }
      draw();

      document.getElementById("shuffleOrderBtn").onclick = () => {
        items = shuffle(items);
        draw();
      };

      document.getElementById("checkOrderBtn").onclick = () => {
        const ok = items.every((v,i) => normalize(v) === normalize(correct[i] || ""));
        const fb = document.getElementById("orderFeedback");
        if (ok) { fb.textContent = "Reihenfolge korrekt ✅"; fb.style.color = "#22c55e"; }
        else { fb.textContent = "Falsche Reihenfolge ❌"; fb.style.color = "#ef4444"; }
        handleAnswer(q, "order_checked", ok);
      };
    }

    // ========== JUSTIFY ==========
    function renderJustify(q) {
      document.getElementById("justifyBox").classList.remove("hidden");
      document.getElementById("checkJustifyBtn").onclick = () => {
        const val = (document.getElementById("justifyText").value || "").trim();
        const ok = checkKeywordAnswer(q, val);
        const fb = document.getElementById("justifyFeedback");
        if (ok) { fb.textContent = "Punkt: ausreichende Begründung ✅"; fb.style.color = "#22c55e"; }
        else {
          fb.innerHTML = "Nicht ganz ❌<br>Erwartete Stichwörter u.a.:<br>- " + (q.stichwoerter || q.schluesselwoerter || []).join("<br>- ");
          fb.style.color = "#ef4444";
        }
        handleAnswer(q, val, ok);
      };
    }

    // ========== FALLANALYSE ==========
    function renderFall(q) {
      document.getElementById("fallBox").classList.remove("hidden");
      document.getElementById("checkFallBtn").onclick = () => {
        const val = (document.getElementById("fallText").value || "").trim();
        const ok = checkKeywordAnswer(q, val);
        const fb = document.getElementById("fallFeedback");
        if (ok) { fb.textContent = "Kernpunkte getroffen ✅"; fb.style.color = "#22c55e"; }
        else {
          fb.innerHTML = "Nicht ganz ❌<br>Wichtige Punkte:<br>- " + (q.stichpunkte || q.schluesselwoerter || []).join("<br>- ");
          fb.style.color = "#ef4444";
        }
        handleAnswer(q, val, ok);
      };
    }

    // =============================
    // Normalisieren / Checks
    // =============================
    function normalize(str) {
      return (str || "")
        .toString()
        .lowerCase?.() ?? (str || "").toString().toLowerCase();
    }
  </script>
  <script>
    // Fallback, falls obiges lowerCase?.() im manchen Browsern meckert:
    function normalize(str) {
      return (str || "")
        .toString()
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[.,;:!?]/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function editDistance(a, b) {
      const dp = Array.from({length: a.length + 1}, () => Array(b.length + 1).fill(0));
      for (let i = 0; i <= a.length; i++) dp[i][0] = i;
      for (let j = 0; j <= b.length; j++) dp[0][j] = j;
      for (let i = 1; i <= a.length; i++) {
        for (let j = 1; j <= b.length; j++) {
          if (a[i-1] === b[j-1]) dp[i][j] = dp[i-1][j-1];
          else dp[i][j] = Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]) + 1;
        }
      }
      return dp[a.length][b.length];
    }

    function checkKeywordAnswer(q, userVal) {
      const userNorm = normalize(userVal);
      const list = q.stichwoerter || q.stichpunkte || q.schluesselwoerter || [];
      if (!Array.isArray(list) || list.length === 0) return false;
      let ok = 0;
      for (const kw of list) {
        const k = normalize(kw);
        if (!k) continue;
        if (userNorm.includes(k)) { ok++; continue; }
        const parts = userNorm.split(" ");
        const near = parts.some(p => editDistance(p, k) <= 1);
        if (near) ok++;
      }
      return ok === list.length;
    }

    function checkInputAnswer(q, userVal) {
      if (q.typ === "calc") {
        const num = parseFloat((userVal || "").replace(",", "."));
        if (isNaN(num)) return false;
        const tol = q.toleranz || 0;
        return Math.abs(num - q.loesungNumerisch) <= tol;
      }

      const userNorm = normalize(userVal);

      if (q.schluesselwoerter && q.schluesselwoerter.length > 0) {
        let ok = 0;
        for (const kw of q.schluesselwoerter) {
          const kwNorm = normalize(kw);
          if (userNorm.includes(kwNorm)) {
            ok++;
          } else {
            const parts = userNorm.split(" ");
            const near = parts.some(p => editDistance(p, kwNorm) <= 1);
            if (near) ok++;
          }
        }
        return ok === q.schluesselwoerter.length;
      }

      if (q.korrekteAntworten && q.korrekteAntworten.length > 0) {
        return q.korrekteAntworten.some(ans => normalize(ans) === userNorm);
      }

      return false;
    }

    // =============================
    // Ergebnis / Punkte
    // =============================
    function handleAnswer(q, userVal, richtig) {
      const already = results.find(r => r.id === q.id);
      if (already) return;

      answered++;
      if (richtig) score++;

      results.push({
        id: q.id,
        frage: q.frage,
        user: (typeof userVal === "string" ? userVal : JSON.stringify(userVal)),
        korrekt: richtig ? "ja" : "nein",
        zeit: new Date().toISOString()
      });

      updateScoreline();
      document.getElementById("showExplainBtn").disabled = false;

      if (answered >= currentQuestions.length) {
        finishTest(false);
      }
    }

    function updateScoreline() {
      const pct = answered > 0 ? Math.round((score / answered) * 100) : 0;
      document.getElementById("scoreline").textContent =
        `Punkte: ${score} / ${answered} (${pct}%)`;
    }

    function finishTest(byTime) {
      clearInterval(timerInterval);
      const pct = answered > 0 ? Math.round((score / answered) * 100) : 0;
      const box = document.getElementById("finalBox");
      box.classList.remove("hidden");
      box.textContent = byTime
        ? `Zeit abgelaufen. Ergebnis: ${score} von ${answered} (${pct}%).`
        : `Test beendet. Ergebnis: ${score} von ${answered} (${pct}%).`;
    }

    // =============================
    // Buttons
    // =============================
    document.getElementById("nextBtn").onclick = () => {
      if (currentIndex < currentQuestions.length - 1) {
        currentIndex++;
        renderQuestion();
      } else {
        finishTest(false);
      }
    };

    document.getElementById("restartBtn").onclick = () => {
      startNewTest();
    };

    document.getElementById("backHomeBtn").onclick = () => {
      clearInterval(timerInterval);
      document.getElementById("testScreen").classList.add("hidden");
      document.getElementById("homeScreen").classList.remove("hidden");
    };

    document.getElementById("showSolutionBtn").onclick = () => {
      const q = currentQuestions[currentIndex];
      const esel = document.getElementById("esel");
      const feedback = document.getElementById("inputFeedback");

      esel.textContent = q.esel || "Hinweis: siehe Skript.";

      if (q.typ === "calc" && typeof q.loesungNumerisch !== "undefined") {
        if (feedback) {
          feedback.innerHTML = "Lösung: <strong>" + q.loesungNumerisch + "</strong>";
          feedback.style.color = "#e2e8f0";
        }
      } else if (q.typ === "match" && q.paare) {
        const fb = document.getElementById("matchFeedback");
        if (fb) {
          fb.innerHTML = "Korrekte Zuordnung:<br>- " + Object.entries(q.paare).map(([l,r]) => `${l} → <strong>${r}</strong>`).join("<br>- ");
          fb.style.color = "#e2e8f0";
        }
      } else if (q.typ === "order" && q.richtigeReihenfolge) {
        const fb = document.getElementById("orderFeedback");
        if (fb) {
          fb.innerHTML = "Richtige Reihenfolge:<br>- " + q.richtigeReihenfolge.join("<br>- ");
          fb.style.color = "#e2e8f0";
        }
      } else if ((q.typ === "justify" || q.typ === "fallanalyse") && (q.stichwoerter || q.stichpunkte)) {
        const fb = (q.typ === "justify") ? document.getElementById("justifyFeedback") : document.getElementById("fallFeedback");
        const list = q.stichwoerter || q.stichpunkte || [];
        if (fb) {
          fb.innerHTML = "Erwartete Stichwörter:<br>- " + list.join("<br>- ");
          fb.style.color = "#e2e8f0";
        }
      } else if (Array.isArray(q.korrekteAntworten) && q.korrekteAntworten.length > 0) {
        if (feedback) {
          feedback.innerHTML = "Lösungsmöglichkeiten:<br>- " + q.korrekteAntworten.join("<br>- ");
          feedback.style.color = "#e2e8f0";
        }
      } else if (Array.isArray(q.schluesselwoerter) && q.schluesselwoerter.length > 0) {
        if (feedback) {
          feedback.innerHTML = "Das musste vorkommen:<br>- " + q.schluesselwoerter.join("<br>- ");
          feedback.style.color = "#e2e8f0";
        }
      }

      // ==== NEU: Inline-Quelle direkt unter der Frage ====
      document.getElementById("srcInline")?.remove();
      if (q.quelle && (q.quelle.kapitel || q.quelle.seite)) {
        const srcLine = document.createElement("div");
        srcLine.id = "srcInline";
        srcLine.style.marginTop = "6px";
        srcLine.style.fontSize = ".75rem";
        srcLine.style.opacity = ".65";
        const kap = q.quelle.kapitel ? String(q.quelle.kapitel) : "";
        const seite = q.quelle.seite ? String(q.quelle.seite) : "";
        srcLine.textContent = `Quelle: ${kap}${seite ? ` (S. ${seite})` : ""}`;
        document.getElementById("questionBox").appendChild(srcLine);
      }
    };

    // ERKLÄRUNG + QUELLEN (Popup)
    document.getElementById("showExplainBtn").onclick = () => {
      const q = currentQuestions[currentIndex];
      const overlay = document.getElementById("explainOverlay");
      const text = document.getElementById("explainText");
      const title = document.getElementById("explainTitle");
      const srcWrap = document.getElementById("explainSourcesWrap");
      const srcBox = document.getElementById("explainSources");

      title.textContent = q.tag ? `Erklärung – ${q.tag}` : "Erklärung";
      text.textContent = q.erklaerung ? q.erklaerung : "Zu dieser Frage ist noch keine Erklärung hinterlegt.";

      // ==== NEU: Quellen aus q.quelle {kapitel, seite} und optional q.quellen[] ====
      srcBox.innerHTML = "";
      let srcItems = [];

      if (q.quelle && (q.quelle.kapitel || q.quelle.seite)) {
        const kap = q.quelle.kapitel ? String(q.quelle.kapitel) : "";
        const seite = q.quelle.seite ? String(q.quelle.seite) : "";
        const line = seite ? `${kap} (S. ${seite})` : kap;
        if (line.trim()) srcItems.push(line);
      }

      if (Array.isArray(q.quellen) && q.quellen.length > 0) {
        q.quellen.forEach(z => {
          const t = (z || "").toString().trim();
          if (t) srcItems.push(t);
        });
      }

      if (srcItems.length > 0) {
        srcItems.forEach((txt, idx) => {
          const div = document.createElement("div");
          div.style.fontSize = ".78rem";
          div.style.background = "rgba(148,163,184,0.08)";
          div.style.border = "1px solid rgba(148,163,184,0.15)";
          div.style.borderRadius = "6px";
          div.style.padding = "4px 6px";
          div.textContent = `${idx + 1}. ${txt}`;
          srcBox.appendChild(div);
        });
        srcWrap.style.display = "block";
      } else {
        srcWrap.style.display = "none";
      }

      overlay.style.display = "flex";
    };

    document.getElementById("closeExplainBtn").onclick = () => {
      document.getElementById("explainOverlay").style.display = "none";
    };

    // TXT-Export
    document.getElementById("exportBtn").onclick = () => {
      const lines = results.map((r, idx) => {
        const frage = r.frage || "—";
        const antwort = (r.user && r.user !== "") ? r.user : "keine Antwort";
        return `Frage ${idx + 1}: ${frage}\nAntwort: ${antwort}\nKorrekt: ${r.korrekt}`;
      });

      const header = `Ergebnisexport – ${new Date().toLocaleString("de-DE")}\nTest: ${(selectedTest && selectedTest.name) || ""}\nBeantwortete Fragen: ${results.length}\nPunkte: ${score} von ${answered}\n\n`;
      const content = header + lines.join("\n\n");

      const blob = new Blob([content], { type: "text/plain" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "test_ergebnisse.txt";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    // =============================
    // Taschenrechner
    // =============================
    function openCalc() {
      const ov = document.getElementById("calcOverlay");
      ov.style.display = "flex";
      calcOpen = true;
      const disp = document.getElementById("calcDisplay");
      const currentVal = document.getElementById("userInput").value;
      disp.value = currentVal || "";
      disp.focus();
      document.addEventListener("keydown", handleCalcKey);
    }
    function closeCalc() {
      document.getElementById("calcOverlay").style.display = "none";
      calcOpen = false;
      document.removeEventListener("keydown", handleCalcKey);
    }
    document.getElementById("closeCalcBtn").onclick = closeCalc;

    function handleCalcKey(e) {
      if (!calcOpen) return;
      const disp = document.getElementById("calcDisplay");

      if (e.key === "Escape") { e.preventDefault(); closeCalc(); return; }

      if (e.key === "Enter") {
        e.preventDefault();
        const raw = disp.value.trim();
        const jsExpr = raw.replace(/,/g, ".");
        let result;
        try {
          if (!/^[0-9+\-*/().\s]+$/.test(jsExpr)) { throw new Error("Unzulässige Zeichen"); }
          result = Function("return " + jsExpr)();
        } catch (err) { result = null; }

        if (typeof result === "number" && isFinite(result)) {
          const displayResult = String(result).replace(".", ",");
          document.getElementById("userInput").value = displayResult;
        } else {
          document.getElementById("userInput").value = raw;
        }
        closeCalc(); return;
      }

      if (["Backspace","Delete","ArrowLeft","ArrowRight","Tab"].includes(e.key)) return;

      const allowed = "0123456789+-*/.,()";
      if (!allowed.includes(e.key)) e.preventDefault();
    }

    window.selectTest = selectTest;
  </script>
</body>
</html>
